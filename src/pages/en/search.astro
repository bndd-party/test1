---
import BaseLayout from "../../layouts/BaseLayout.astro";

const pageTitle = "Search";
const description = "Search posts by keyword.";
---

<BaseLayout pageTitle={pageTitle} description={description}>
  <section class="search-page">
    <h1>Search</h1>

    <p class="lead">Search posts by title, summary, or content.</p>

    <div class="search-box">
      <input id="q" type="search" placeholder="e.g. figure, paint, photo" />
      <button id="btn" type="button">Search</button>
    </div>

    <div id="results" class="results" aria-live="polite"></div>
  </section>

  <script type="module">
    const input = document.getElementById("q");
    const btn = document.getElementById("btn");
    const results = document.getElementById("results");

    const escapeHtml = (s) =>
      s.replaceAll("&", "&amp;")
       .replaceAll("<", "&lt;")
       .replaceAll(">", "&gt;")
       .replaceAll('"', "&quot;")
       .replaceAll("'", "&#039;");

    async function loadIndex() {
      const res = await fetch("/search-index.json");
      if (!res.ok) throw new Error("Could not load search-index.json");
      return await res.json();
    }

    function render(items, query) {
      if (!query) {
        results.innerHTML = "";
        return;
      }
      if (!items.length) {
        results.innerHTML = `<p class="empty">No results found for "${escapeHtml(query)}".</p>`;
        return;
      }

      results.innerHTML = `
        <ul class="result-list">
          ${items
            .map(
              (p) => `
            <li class="result-item">
              <a href="${p.url}">${escapeHtml(p.title)}</a>
              ${p.description ? `<p>${escapeHtml(p.description)}</p>` : ""}
              ${p.pubDate ? `<time datetime="${p.pubDate}">${escapeHtml(p.pubDate)}</time>` : ""}
            </li>
          `
            )
            .join("")}
        </ul>
      `;
    }

    function normalize(s) {
      return (s ?? "").toLowerCase();
    }

    async function run() {
      const query = input.value.trim();
      const index = await loadIndex();

        // ★EnページではEnだけ（Ja を除外）
      const filtered = index.filter((p) => p.lang === "en");

      const q = normalize(query);
      const hits = filtered.filter((p) => {
        const hay = normalize([p.title, p.description, p.body].join(" "));
        return hay.includes(q);
      });

      render(hits, query);
    }

    btn.addEventListener("click", run);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") run();
    });

    // URLの ?q= を拾って自動検索
    const params = new URLSearchParams(location.search);
    const q0 = params.get("q");
    if (q0) {
      input.value = q0;
      run();
    }
  </script>
</BaseLayout>
